<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Workflow-engine by jspc</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Workflow-engine</h1>
      <h2 class="project-tagline">Distributed Workflow Tool</h2>
      <a href="https://github.com/jspc/workflow-engine" class="btn">View on GitHub</a>
      <a href="https://github.com/jspc/workflow-engine/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/jspc/workflow-engine/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="workflow-engine" class="anchor" href="#workflow-engine" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>workflow-engine</h1>

<p>workflow-engine is a simple distributed workflow engine, including task brokerage and staefulness, written in go.</p>

<p>It contains three components; of which there may be any number, above one, of instances:</p>

<ul>
<li>Master Nodes</li>
<li>Job Nodes</li>
<li>API Nodes</li>
</ul>

<p>And a couple of dependencies:</p>

<ul>
<li>RabbitMQ</li>
<li>Redis</li>
</ul>

<p>A <code>workflow</code> is made up of <code>tasks</code> and <code>variables</code> and collated in a <code>runner</code> which stores state for out simple state machine to manage state with.</p>

<table>
<thead>
<tr>
<th>who</th>
<th>what</th>
</tr>
</thead>
<tbody>
<tr>
<td>dockerhub</td>
<td><a href="https://hub.docker.com/r/jspc/workflow-engine/">https://hub.docker.com/r/jspc/workflow-engine/</a></td>
</tr>
<tr>
<td>circleci</td>
<td><a href="https://circleci.com/gh/jspc/workflow-engine">https://circleci.com/gh/jspc/workflow-engine</a></td>
</tr>
<tr>
<td>licence</td>
<td>MIT</td>
</tr>
</tbody>
</table>

<h2>
<a id="master-nodes" class="anchor" href="#master-nodes" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Master Nodes</h2>

<p>Master nodes are run with:</p>

<pre><code>$ workflow-engine -mode master -amqp amqp://guest:guest@localhost/vhost -redis redis://localhost:6379/0
</code></pre>

<p>Or via docker:</p>

<pre><code>$ docker run -p8080:8080 jspc/workflow-engine -mode master -amqp amqp://guest:guest@localhost/vhost -redis redis://localhost:6379/0
</code></pre>

<p>Master nodes compile and broker workflow tasks via a runner.</p>

<h2>
<a id="job-nodes" class="anchor" href="#job-nodes" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Job Nodes</h2>

<p>Job nodes are run with:</p>

<pre><code>$ workflow-engine -mode job -amqp amqp://guest:guest@localhost/vhost
</code></pre>

<p>Or via docker:</p>

<pre><code>$ docker run -p8080:8080 jspc/workflow-engine -mode job -amqp amqp://guest:guest@localhost/vhost
</code></pre>

<p>Job nodes receive formatted tasks via rabbitmq, execute the task and return outputs and metadata.</p>

<h2>
<a id="api-nodes" class="anchor" href="#api-nodes" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>API Nodes</h2>

<p>API nodes are run with:</p>

<pre><code>$ workflow-engine -mode job -amqp amqp://guest:guest@localhost/vhost -redis redis://localhost:6379/0 -host 0.0.0.0 -port 8080
</code></pre>

<p>Or via docker:</p>

<pre><code>$ docker run -p8080:8080 jspc/workflow-engine -mode job -amqp amqp://guest:guest@localhost/vhost -redis redis://localhost:6379/ -host 0.0.0.0 -port 8080
</code></pre>

<p>API nodes provide an interface to the engine; for starting and configuring workflows.</p>

<p><strong>Note</strong>: There is no auth-n, auth-z nor much of anything in front of the API. You should either use an API gateway or router in front of the tool. It probably wont be included in this project; it seems out of scope.</p>

<h2>
<a id="architecture" class="anchor" href="#architecture" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Architecture</h2>

<p><img src="img/workflow-engine.png" alt="naive workflow-engine architecture diagram"></p>

<h2>
<a id="workflows" class="anchor" href="#workflows" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Workflows</h2>

<p>A workflow definition looks like:</p>

<div class="highlight highlight-source-json"><pre>{
    <span class="pl-s"><span class="pl-pds">"</span>name<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>do stuff<span class="pl-pds">"</span></span>,
    <span class="pl-s"><span class="pl-pds">"</span>variables<span class="pl-pds">"</span></span>: {
        <span class="pl-s"><span class="pl-pds">"</span>echo_url<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>http://172.17.0.1:8000/some-endpoint<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>content_type<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>application/data<span class="pl-pds">"</span></span>
    },
    <span class="pl-s"><span class="pl-pds">"</span>steps<span class="pl-pds">"</span></span>: [{
        <span class="pl-s"><span class="pl-pds">"</span>name<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>Test Stuff<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>type<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>post-to-web<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>context<span class="pl-pds">"</span></span>: {
            <span class="pl-s"><span class="pl-pds">"</span>url<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>{{.Defaults.echo_url}}<span class="pl-pds">"</span></span>,
            <span class="pl-s"><span class="pl-pds">"</span>content-type<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>{{.Defaults.content_type}}<span class="pl-pds">"</span></span>,
            <span class="pl-s"><span class="pl-pds">"</span>data<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>foo=bar<span class="pl-pds">"</span></span>
        },
        <span class="pl-s"><span class="pl-pds">"</span>register<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>echo_data<span class="pl-pds">"</span></span>
    }, {
        <span class="pl-s"><span class="pl-pds">"</span>name<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>Templatery Stuff<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>type<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>log<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>context<span class="pl-pds">"</span></span>: {
            <span class="pl-s"><span class="pl-pds">"</span>message<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>{{.echo_data.Host}}<span class="pl-pds">"</span></span>
        },
        <span class="pl-s"><span class="pl-pds">"</span>register<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>something<span class="pl-pds">"</span></span>
    }]
}</pre></div>

<p>The initial set of variables are accessible via the <code>.Defaults</code> key in context templates. These templates allow:</p>

<ul>
<li>DRYing up of step data</li>
<li>The ability to rely on the output of a previous step</li>
</ul>

<p>To access the output of a previous step, one must <code>register</code> the step with a unique name. This will be recognisable by ansible users, for example (in fact: thats where I stole the idea).</p>

<p>A workflow is kicked off via an api call:</p>

<div class="highlight highlight-source-shell"><pre>curl -X POST -d <span class="pl-s"><span class="pl-pds">'</span>{"Name": "nontrivial workflow", "Variables":{"foo": "bar"} }<span class="pl-pds">'</span></span> localhost:8080/wf/</pre></div>

<p>The object <code>Variables</code> may be omitted: this is useful for data which is not known until runtime, and is made availabled via the <code>.Rumtime</code> key in context templates; in an identical fashion to how <code>.Defaults</code> works.</p>

<p>The request mints, and returns, a UUID. A workflow runner is attached to this uuid. This uuid can be used to view the status of a workflow; like the follow failed workflow:</p>

<div class="highlight highlight-source-shell"><pre>$ curl localhost:8080/wf/7423bbb5-b020-4410-91b6-a5e2754e6a47</pre></div>

<p>Returning:</p>

<div class="highlight highlight-source-json"><pre>{
  <span class="pl-s"><span class="pl-pds">"</span>EndTime<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>2016-12-14T11:40:54.367619801Z<span class="pl-pds">"</span></span>,
  <span class="pl-s"><span class="pl-pds">"</span>ErrorMessage<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>Step <span class="pl-cce">\"</span>Test Stuff<span class="pl-cce">\"</span> failed. See below<span class="pl-pds">"</span></span>,
  <span class="pl-s"><span class="pl-pds">"</span>Last<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>Test Stuff<span class="pl-pds">"</span></span>,
  <span class="pl-s"><span class="pl-pds">"</span>StartTime<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>2016-12-14T11:34:32.703863903Z<span class="pl-pds">"</span></span>,
  <span class="pl-s"><span class="pl-pds">"</span>State<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>failed<span class="pl-pds">"</span></span>,
  <span class="pl-s"><span class="pl-pds">"</span>UUID<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>7423bbb5-b020-4410-91b6-a5e2754e6a47<span class="pl-pds">"</span></span>,
  <span class="pl-s"><span class="pl-pds">"</span>Variables<span class="pl-pds">"</span></span>: {
    <span class="pl-s"><span class="pl-pds">"</span>Defaults<span class="pl-pds">"</span></span>: {
      <span class="pl-s"><span class="pl-pds">"</span>content_type<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>application/data<span class="pl-pds">"</span></span>,
      <span class="pl-s"><span class="pl-pds">"</span>echo_url<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>http://172.17.0.1:8000/some-endpoint<span class="pl-pds">"</span></span>
    }
  },
  <span class="pl-s"><span class="pl-pds">"</span>Workflow<span class="pl-pds">"</span></span>: {
    <span class="pl-s"><span class="pl-pds">"</span>Name<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>do stuff<span class="pl-pds">"</span></span>,
    <span class="pl-s"><span class="pl-pds">"</span>Steps<span class="pl-pds">"</span></span>: [
      {
        <span class="pl-s"><span class="pl-pds">"</span>Context<span class="pl-pds">"</span></span>: {
          <span class="pl-s"><span class="pl-pds">"</span>content-type<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>application/data<span class="pl-pds">"</span></span>,
          <span class="pl-s"><span class="pl-pds">"</span>data<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>foo=bar<span class="pl-pds">"</span></span>,
          <span class="pl-s"><span class="pl-pds">"</span>url<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>http://172.17.0.1:8000/some-endpoint<span class="pl-pds">"</span></span>
        },
        <span class="pl-s"><span class="pl-pds">"</span>Duration<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>2 ms<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>End<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>2016-12-14T11:36:06<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>ErrorMessage<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>Post http://172.17.0.1:8000/some-endpoint: dial tcp 172.17.0.1:8000: getsockopt: connection refused<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>Failed<span class="pl-pds">"</span></span>: <span class="pl-c1">true</span>,
        <span class="pl-s"><span class="pl-pds">"</span>Name<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>Test Stuff<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>Register<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>echo_data<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>Start<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>2016-12-14T11:36:06<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>Type<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>post-to-web<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>UUID<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>
      },
      {
        <span class="pl-s"><span class="pl-pds">"</span>Context<span class="pl-pds">"</span></span>: {
          <span class="pl-s"><span class="pl-pds">"</span>message<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>{{.echo_data.Host}}<span class="pl-pds">"</span></span>
        },
        <span class="pl-s"><span class="pl-pds">"</span>Duration<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>End<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>ErrorMessage<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>Failed<span class="pl-pds">"</span></span>: <span class="pl-c1">false</span>,
        <span class="pl-s"><span class="pl-pds">"</span>Name<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>Templatery Stuff<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>Register<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>something<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>Start<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>Type<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>log<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>UUID<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>
      }
    ],
    <span class="pl-s"><span class="pl-pds">"</span>Variables<span class="pl-pds">"</span></span>: {
      <span class="pl-s"><span class="pl-pds">"</span>content_type<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>application/data<span class="pl-pds">"</span></span>,
      <span class="pl-s"><span class="pl-pds">"</span>echo_url<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>http://172.17.0.1:8000/some-endpoint<span class="pl-pds">"</span></span>
    }
  }
}</pre></div>

<p>Here we see the first step has been compiled, yet the second step has npt. This is because a step is compiled right before it is run, to allow it access to the latest data. We can also see the runner has failed; it could not get access to a service and thus bombs out.</p>

<h2>
<a id="licence" class="anchor" href="#licence" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Licence</h2>

<p>MIT License</p>

<p>Copyright (c) 2016 jspc</p>

<p>Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:</p>

<p>The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.</p>

<p>THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.</p>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/jspc/workflow-engine">Workflow-engine</a> is maintained by <a href="https://github.com/jspc">jspc</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
